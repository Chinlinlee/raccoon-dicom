name: CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-22.04

    services:
      mongodb:
        image: mongo:4.4
        env:
          MONGO_INITDB_DATABASE: admin
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: root
          MONGO_PORT: 27017
        options: >-
          --health-cmd mongo
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017


    steps:
    - name: Echo the mongodb service ID / Network / Ports
      run: |
        echo "id: ${{ job.services.mongodb.id }}"
        echo "network: ${{ job.services.mongodb.network }}"
        echo "ports: ${{ job.services.mongodb.ports }}"

    - name: Checkout self
      uses: actions/checkout@v3
      with:
        path: "raccoon-dicom"
      
    - name: Checkout Chinlinlee/raccoon-test
      uses: actions/checkout@v3
      with:
        repository: Chinlinlee/raccoon-test
        repo_token: ${{ secrets.MY_PAT }}
        lfs: true
        path: "raccoon-test"
        
    - name: Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'


    - name: Create env file
      run: |
        touch raccoon-dicom/.env
        echo 'MONGODB_NAME="raccoon"' >> raccoon-dicom/.env
        echo 'MONGODB_HOSTS=["mongodb"]' >> raccoon-dicom/.env
        echo 'MONGODB_PORTS=[27017]' >> raccoon-dicom/.env
        echo 'MONGODB_USER="root"' >> raccoon-dicom/.env
        echo 'MONGODB_PASSWORD="root"' >> raccoon-dicom/.env
        echo 'MONGODB_AUTH_SOURCE="admin"' >> raccoon-dicom/.env
        echo 'MONGODB_IS_SHARDING_MODE=false' >> raccoon-dicom/.env
        echo 'SERVER_PORT=8082' >> raccoon-dicom/.env
        echo 'SERVER_SESSION_SECRET_KEY="se-key"' >> raccoon-dicom/.env
        echo 'SYCN_TO_FHIR_SERVER=false' >> raccoon-dicom/.env
    
    - name: Create test config
      run: |
        touch raccoon-test/config/config.js
        echo 'module.exports.config={DICOMwebServer:{baseUrl:"http://localhost:8082",qidoPrefix:"dicom-web",wadoPrefix:"dicom-web",stowPrefix:"dicom-web",wadoUriPrefix:"wado"}};' >> raccoon-test/config/config.js

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'adopt'
        
    - name: Build and test
      run: |
        echo $PWD
        cd raccoon-dicom
        npm install
        cp ./plugins/config.template.js ./plugins/config.js
        export DCMDICTPATH=$PWD/models/DICOM/dcmtk/dicom.dic
        echo $DCMDICTPATH
        node server.js &
        cd ../raccoon-test
        npm install
        npm install -g mocha
        sleep 20s
        mocha --config ./test.mocharc.js